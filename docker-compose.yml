version: '3'
services:

  proxy:
    image: ${REGISTRY}/hub_docker_proxy
    container_name: hub_docker_proxy
    labels:
      - traefik.enable=true
      - traefik.http.services.traefik.loadbalancer.server.port=8080
      - traefik.http.routers.traefik.tls=true
      - traefik.http.routers.traefik.rule=(PathPrefix(`/traefik/`) || Headers(`Referer`, `https://${HOST}/traefik/dashboard/`))
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.routers.traefik.middlewares=strip-traefik
      - traefik.http.middlewares.strip-traefik.stripprefix.prefixes=/traefik
    restart: unless-stopped
    command:
      - "--api"
      - "--api.insecure=true"
      - "--providers.docker"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - hub

  rstudio:
    image: ${REGISTRY}/rstudio_docker_app
    container_name: rstudio_docker_app
    labels:
      - traefik.enable=true
      - traefik.http.services.rstudio.loadbalancer.server.port=8787
      - traefik.http.routers.rstudio.tls=true
      - traefik.http.routers.rstudio.rule=Host(`${HOST}`)
      - traefik.http.services.rstudio=rstudio
    restart: unless-stopped
    stdin_open: true
    tty: true
    volumes:
      - /home:/home
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
      - /etc/shadow:/etc/shadow:ro
    networks:
      - hub

  jupyterhub:
    image: ${REGISTRY}/jupyterhub_docker_app
    container_name: jupyterhub_docker_app
    labels:
      - traefik.enable=true
      - traefik.http.services.jupyterhub.loadbalancer.server.port=8000
      - traefik.http.routers.jupyterhub.tls=true
      - traefik.http.routers.jupyterhub.rule=Host(`${HOST}`) && (PathPrefix(`/jupyterhub/`) || PathPrefix(`/hub/`) || PathPrefix(`/user/`))
      - traefik.http.routers.jupyterhub.middlewares=strip-jupyterhub@docker
      - traefik.http.middlewares.strip-jupyterhub.stripprefix.prefixes=/jupyterhub
    restart: unless-stopped
    stdin_open: true
    tty: true
    volumes:
      - /home:/home
      - /etc/passwd:/etc/passwd:ro
      - /etc/shadow:/etc/shadow:ro
      - /etc/gshadow:/etc/gshadow:ro
      - /etc/group:/etc/group:ro
      - /etc/pam.d:/etc/pam.d:ro
      - /etc/authselect/:/etc/authselect:ro
    networks:
      - hub

networks:
  hub:
